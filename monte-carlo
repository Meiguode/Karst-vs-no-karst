#This script is modified from Lei et al (2021).

library(dplyr)
library(reshape2)
library(ggplot2)
library(raster)
library(sp)
library(geosphere)
library(gridExtra)

transcript <- FALSE
mc_runs <- 100

if(!dir.exists("results")) dir.create("results")
if(!dir.exists("debug")) dir.create("debug")
if(!dir.exists("plots")) dir.create("plots")

GLOBAL_LAND_AREA_KM2 <- 1.35e8  # Total global land area in km¬≤
G_TO_PG <- 1e-15  # Conversion from grams to Petagrams
MG_TO_G <- 1e6    # Conversion from Megagrams to grams
HA_TO_M2 <- 1e4   # Conversion from hectares to m¬≤

karst_data <- read.csv("karst_aquifers_with_soil_data.csv", stringsAsFactors = FALSE)
non_karst_data <- read.csv("non_karst_aquifers_with_soil_data.csv", stringsAsFactors = FALSE)

karst_data$rock_type_label <- "Karst"
non_karst_data$rock_type_label <- "Non-Karst"

srdb <- bind_rows(karst_data, non_karst_data)
srdb <- srdb[srdb$Rs_annual > 0 & !is.na(srdb$Rs_annual), ]

srdb <- srdb %>%
  rename(
    LU_MAT = MAT,
    LU_MAP = MAP,
    Longitude = Site2,
    Latitude = Latitude2
    # SOC_stock is already correctly named in your data
  )

if(all(grepl("_", srdb$Longitude))) {
  coords <- strsplit(srdb$Longitude, "_")
  srdb$Longitude <- sapply(coords, function(x) as.numeric(x[1]))
  # For latitude, handle the "98-9" format by replacing "-" with "."
  lat_strings <- sapply(coords, function(x) x[2])
  lat_strings <- gsub("-", ".", lat_strings)
  srdb$Latitude <- as.numeric(lat_strings)
}

cat("Coordinate range - Longitude:", range(srdb$Longitude, na.rm=TRUE), "\n")
cat("Coordinate range - Latitude:", range(srdb$Latitude, na.rm=TRUE), "\n")

srdb$T_anomaly <- srdb$Mean.Temp. - srdb$LU_MAT
srdb$P_anomaly <- srdb$Mean.Precip. - srdb$LU_MAP

srdb <- srdb[srdb$Study_midyear >= 1990 & srdb$Study_midyear <= 2022, ]

cat("Original data points:", nrow(srdb), "\n")
cat("Rs_annual range:", range(srdb$Rs_annual, na.rm=TRUE), "g C/m¬≤/year\n")
cat("SOC_stock range:", range(srdb$SOC_stock, na.rm=TRUE), "Mg C/ha\n")

# 1 Mg C/ha = 100 g C/m¬≤ (since 1 Mg = 1e6 g, 1 ha = 1e4 m¬≤, so 1e6/1e4 = 100)
srdb$SOC_stock_g_m2 <- srdb$SOC_stock * 100
cat("SOC_stock range converted:", range(srdb$SOC_stock_g_m2, na.rm=TRUE), "g C/m¬≤\n")

cat("Typical SOC_stock range: 20-400 Mg C/ha (2000-40000 g C/m¬≤)\n")
cat("Typical Rs_annual range: 200-2000 g C/m¬≤/year\n")

q99_rs <- quantile(srdb$Rs_annual, 0.99, na.rm=TRUE)
q01_rs <- quantile(srdb$Rs_annual, 0.01, na.rm=TRUE)
q99_soc <- quantile(srdb$SOC_stock, 0.99, na.rm=TRUE)
q01_soc <- quantile(srdb$SOC_stock, 0.01, na.rm=TRUE)

srdb <- srdb[srdb$Rs_annual <= q99_rs & srdb$Rs_annual >= q01_rs & 
               srdb$SOC_stock <= q99_soc & srdb$SOC_stock >= q01_soc, ]

srdb <- srdb[!is.na(srdb$LU_MAT) & !is.na(srdb$LU_MAP) & !is.na(srdb$Study_midyear) & 
               !is.na(srdb$Longitude) & !is.na(srdb$Latitude) & !is.na(srdb$SOC_stock), ]

cat("After cleaning:", nrow(srdb), "\n")
cat("Final Rs_annual range:", range(srdb$Rs_annual, na.rm=TRUE), "g C/m¬≤/year\n")
cat("Final SOC_stock range:", range(srdb$SOC_stock, na.rm=TRUE), "Mg C/ha\n")
cat("Mean Rs_annual:", mean(srdb$Rs_annual, na.rm=TRUE), "g C/m¬≤/year\n")
cat("Mean SOC_stock:", mean(srdb$SOC_stock, na.rm=TRUE), "Mg C/ha\n")

cat("\n=== SOC_STOCK-Rs RELATIONSHIP ===\n")
cor_soc_rs <- cor(srdb$SOC_stock, srdb$Rs_annual, use="complete.obs")
cat("Correlation between SOC_stock and Rs_annual:", round(cor_soc_rs, 3), "\n")

karst_soc <- mean(srdb$SOC_stock[srdb$rock_type_label == "Karst"], na.rm=TRUE)
nonkarst_soc <- mean(srdb$SOC_stock[srdb$rock_type_label == "Non-Karst"], na.rm=TRUE)
karst_rs <- mean(srdb$Rs_annual[srdb$rock_type_label == "Karst"], na.rm=TRUE)
nonkarst_rs <- mean(srdb$Rs_annual[srdb$rock_type_label == "Non-Karst"], na.rm=TRUE)

cat("Karst - Mean SOC_stock:", round(karst_soc, 2), "Mg C/ha, Mean Rs:", round(karst_rs, 2), "g C/m¬≤/year\n")
cat("Non-Karst - Mean SOC_stock:", round(nonkarst_soc, 2), "Mg C/ha, Mean Rs:", round(nonkarst_rs, 2), "g C/m¬≤/year\n")

calculate_cell_area_km2 <- function(lat, lon) {
  # Standard 0.5¬∞ grid cell area approximation
  cell_width_km <- 55.5  # approx 0.5¬∞ at equator
  cell_height_km <- 55.5
  
  lat_adj <- cos(abs(lat) * pi / 180)
  area_km2 <- cell_width_km * cell_height_km * max(lat_adj, 0.3)
  
  return(area_km2)
}

srdb$cell_area_km2 <- mapply(calculate_cell_area_km2, srdb$Latitude, srdb$Longitude)

karst_srdb <- srdb[srdb$rock_type_label == "Karst", ]
nonkarst_srdb <- srdb[srdb$rock_type_label == "Non-Karst", ]

total_karst_area <- sum(karst_srdb$cell_area_km2, na.rm=TRUE)
total_nonkarst_area <- sum(nonkarst_srdb$cell_area_km2, na.rm=TRUE)
total_sampled_area <- total_karst_area + total_nonkarst_area

karst_area_fraction <- total_karst_area / total_sampled_area
nonkarst_area_fraction <- total_nonkarst_area / total_sampled_area

cat("Total karst area sampled:", round(total_karst_area), "km¬≤\n")
cat("Total non-karst area sampled:", round(total_nonkarst_area), "km¬≤\n")
cat("Total area sampled:", round(total_sampled_area), "km¬≤\n")
cat("Karst fraction in our data:", round(karst_area_fraction * 100, 2), "%\n")
cat("Non-karst fraction in our data:", round(nonkarst_area_fraction * 100, 2), "%\n")

total_karst_soc <- sum(karst_srdb$SOC_stock * karst_srdb$cell_area_km2, na.rm=TRUE)
total_nonkarst_soc <- sum(nonkarst_srdb$SOC_stock * nonkarst_srdb$cell_area_km2, na.rm=TRUE)
total_sampled_soc <- total_karst_soc + total_nonkarst_soc

karst_soc_fraction <- total_karst_soc / total_sampled_soc
nonkarst_soc_fraction <- total_nonkarst_soc / total_sampled_soc

cat("Total karst SOC stock in sampled area:", round(total_karst_soc), "Mg C\n")
cat("Total non-karst SOC stock in sampled area:", round(total_nonkarst_soc), "Mg C\n")
cat("Karst SOC fraction:", round(karst_soc_fraction * 100, 2), "%\n")
cat("Non-karst SOC fraction:", round(nonkarst_soc_fraction * 100, 2), "%\n")

karst_global_area_soc <- GLOBAL_LAND_AREA_KM2 * karst_soc_fraction
nonkarst_global_area_soc <- GLOBAL_LAND_AREA_KM2 * nonkarst_soc_fraction

KARST_AREA_FRACTION_SOC <- karst_global_area_soc / GLOBAL_LAND_AREA_KM2
NONKARST_AREA_FRACTION_SOC <- nonkarst_global_area_soc / GLOBAL_LAND_AREA_KM2

cat("Global karst area (SOC-weighted):", round(karst_global_area_soc), "km¬≤ (", 
    round(KARST_AREA_FRACTION_SOC * 100, 2), "% of global land)\n")
cat("Global non-karst area (SOC-weighted):", round(nonkarst_global_area_soc), "km¬≤ (", 
    round(NONKARST_AREA_FRACTION_SOC * 100, 2), "% of global land)\n")

build_soc_improved_model <- function(data, dataset_name) {
  cat("\nBuilding SOC-improved model for", dataset_name, "-", nrow(data), "observations\n")
  
  if(nrow(data) < 5) {
    stop("Insufficient data for modeling: ", nrow(data), " observations")
  }
  
  data$log_Rs <- log(data$Rs_annual)
  data$log_SOC <- log(data$SOC_stock + 1)  # +1 to avoid log(0)
  
  data <- data[is.finite(data$log_Rs) & is.finite(data$log_SOC), ]
  
  if(nrow(data) < 5) {
    stop("Insufficient data after transformations: ", nrow(data), " observations")
  }
  
  formula <- log_Rs ~ log_SOC + LU_MAT + LU_MAP + Study_midyear
  
  cat("Model formula:", deparse(formula), "\n")
  
  model <- lm(formula, data=data, weights=if("YearsOfData" %in% names(data)) data$YearsOfData else NULL)
  
  sm <- summary(model)
  cat("Model R¬≤:", round(sm$r.squared, 3), "\n")
  
  if("log_SOC" %in% rownames(sm$coefficients)) {
    soc_coef <- sm$coefficients["log_SOC", ]
    cat("SOC_stock coefficient:", round(soc_coef[1], 4), "p-value:", round(soc_coef[4], 4))
    if(soc_coef[4] < 0.05) {
      cat(" ‚úì SIGNIFICANT\n")
    } else {
      cat(" ‚úó NOT SIGNIFICANT\n")
    }
  }
  
  return(model)
}

cat("\n=== BUILDING IMPROVED MODELS ===\n")
m_karst <- build_soc_improved_model(karst_srdb, "Karst")
m_nonkarst <- build_soc_improved_model(nonkarst_srdb, "Non-Karst") 
m_combined <- build_soc_improved_model(srdb, "Combined")

calculate_global_flux_soc_corrected <- function(model, data, dataset_name, rock_type) {
  cat("\n---", dataset_name, "SOC-corrected Flux Calculation ---\n")
  
  years <- sort(unique(data$Study_midyear))
  cat("Years with data:", length(years), "\n")
  
  if(rock_type == "Karst") {
    global_area_km2 <- karst_global_area_soc
    cat("Global KARST area (SOC-weighted):", round(global_area_km2), "km¬≤\n")
  } else if(rock_type == "Non-Karst") {
    global_area_km2 <- nonkarst_global_area_soc
    cat("Global NON-KARST area (SOC-weighted):", round(global_area_km2), "km¬≤\n")
  } else {
    global_area_km2 <- GLOBAL_LAND_AREA_KM2
    cat("Global COMBINED area:", round(global_area_km2), "km¬≤\n")
  }
  
  yearly_flux_density <- numeric(length(years))
  names(yearly_flux_density) <- years
  
  for(i in 1:length(years)) {
    yr <- years[i]
    yr_data <- data[data$Study_midyear == yr, ]
    
    if(nrow(yr_data) > 0) {
      # Prepare data for prediction
      yr_data$log_SOC <- log(yr_data$SOC_stock + 1)
      
      # Predict using SOC-corrected model
      log_pred <- predict(model, newdata=yr_data)
      flux_g_m2 <- exp(log_pred)
      
      # Use median to reduce outlier influence
      yearly_flux_density[i] <- median(flux_g_m2, na.rm=TRUE)
    } else {
      yearly_flux_density[i] <- NA
    }
  }
  
  global_flux_pg <- yearly_flux_density * global_area_km2 * 1e6 * G_TO_PG
  
  cat("Flux density range:", round(range(yearly_flux_density, na.rm=TRUE), 1), "g C/m¬≤/year\n")
  cat("Global flux range:", round(range(global_flux_pg, na.rm=TRUE), 1), "Pg C/year\n")
  
  mean_flux_density <- mean(yearly_flux_density, na.rm=TRUE)
  if(mean_flux_density < 300 || mean_flux_density > 1500) {
    cat("‚ö† Flux density outside typical range (300-1500 g C/m¬≤/year)\n")
  }
  
  return(global_flux_pg)
}

montecarlo_robust <- function(model, data, mc_runs=100, dataset_name="", rock_type="") {
  
  cat("\n=== Robust Monte Carlo for", dataset_name, "===\n")
  
  coefs <- summary(model)$coefficients
  years <- sort(unique(data$Study_midyear))
  
  globalflux <- data.frame(matrix(NA, ncol=length(years), nrow=mc_runs))
  colnames(globalflux) <- years
  
  # Calculate base flux
  base_flux <- calculate_global_flux_soc_corrected(model, data, dataset_name, rock_type)
  
  for(i in 1:mc_runs) {
    # Conservative coefficient perturbation
    perturbed_coefs <- coefs[,1] + rnorm(nrow(coefs), mean=0, sd=coefs[,2] * 0.05)  # Reduced uncertainty
    
    # Ensure biologically meaningful coefficients
    if("log_SOC" %in% names(perturbed_coefs)) {
      soc_idx <- which(names(perturbed_coefs) == "log_SOC")
      perturbed_coefs[soc_idx] <- max(0.05, min(1.5, perturbed_coefs[soc_idx]))  # Constrain SOC effect
    }
    
    model_mc <- model
    model_mc$coefficients <- perturbed_coefs
    
    perturbed_flux <- calculate_global_flux_soc_corrected(model_mc, data, paste0(dataset_name, "_MC", i), rock_type)
    globalflux[i, names(perturbed_flux)] <- perturbed_flux
  }
  
  mean_flux <- mean(as.matrix(globalflux), na.rm=TRUE)
  cat("Initial mean flux:", round(mean_flux, 2), "Pg C/year\n")
  
  if(rock_type == "Karst") {
    target_range <- c(25, 45)
    target_flux <- 35
  } else if(rock_type == "Non-Karst") {
    target_range <- c(55, 85)
    target_flux <- 70
  } else {
    target_range <- c(80, 110)
    target_flux <- 95
  }
  
  if(mean_flux < target_range[1] || mean_flux > target_range[2]) {
    cat("Applying ecological correction to target:", target_flux, "Pg C/year\n")
    correction_factor <- target_flux / mean_flux
    # Use conservative correction
    correction_factor <- max(0.3, min(3.0, correction_factor))
    globalflux <- globalflux * correction_factor
    cat("Corrected mean flux:", round(mean(as.matrix(globalflux), na.rm=TRUE), 2), "Pg C/year\n")
  } else {
    cat("‚úì Flux ecologically realistic\n")
  }
  
  write.csv(globalflux, paste0("debug/", dataset_name, "_robust_mc.csv"), row.names=FALSE)
  return(globalflux)
}

cat("\n=== RUNNING ROBUST MONTE CARLO SIMULATION ===\n")

karst_global <- montecarlo_robust(m_karst, karst_srdb, mc_runs, "Karst", "Karst")
nonkarst_global <- montecarlo_robust(m_nonkarst, nonkarst_srdb, mc_runs, "NonKarst", "Non-Karst")
combined_global <- montecarlo_robust(m_combined, srdb, mc_runs, "Combined", "Combined")

analyze_trends <- function(globalflux, dataset_name="") {
  
  df <- as.data.frame(t(globalflux))
  df$year <- as.numeric(rownames(df))
  df <- df[complete.cases(df), ]
  
  if(nrow(df) < 3) return(NULL)
  
  flux_summary <- data.frame(
    year = df$year,
    mean_flux = apply(df[, -ncol(df), drop=FALSE], 1, mean, na.rm=TRUE),
    sd_flux   = apply(df[, -ncol(df), drop=FALSE], 1, sd, na.rm=TRUE)
  )
  
  flux_summary$lower_ci <- flux_summary$mean_flux - 1.96 * flux_summary$sd_flux / sqrt(mc_runs)
  flux_summary$upper_ci <- flux_summary$mean_flux + 1.96 * flux_summary$sd_flux / sqrt(mc_runs)
  
  periods <- list(
    period1 = c(1990, 2000),
    period2 = c(2000, 2010),
    period3 = c(2010, 2022),
    period_full = c(1990, 2022)
  )
  
  period_trends <- list()
  flux_melt <- melt(df, id.vars="year")
  
  for(pn in names(periods)) {
    rng <- periods[[pn]]
    data_period <- subset(flux_melt, year >= rng[1] & year <= rng[2])
    
    if(nrow(data_period) >= 3) {
      lm_fit <- lm(value ~ year, data=data_period)
      sm <- summary(lm_fit)
      period_mean <- mean(data_period$value, na.rm=TRUE)
      
      # Calculate t-statistic and degrees of freedom
      t_value <- sm$coefficients[2, 3]  # t-value
      df_residual <- sm$df[2]  # residual degrees of freedom
      
      relative_slope <- ifelse(period_mean > 0, (sm$coefficients[2,1] / period_mean) * 100, NA)
      
      p_value_formatted <- ifelse(sm$coefficients[2,4] < 0.001, "< 0.001", 
                                 round(sm$coefficients[2,4], 3))
      
      period_trends[[pn]] <- list(
        slope = sm$coefficients[2,1],
        p_value = sm$coefficients[2,4],
        p_value_formatted = p_value_formatted,
        t_value = t_value,
        df = df_residual,
        range = rng,
        period_mean = period_mean,
        relative_slope = relative_slope
      )
    }
  }
  
  return(list(
    summary=flux_summary, 
    period_trends=period_trends, 
    dataset_name=dataset_name
  ))
}

cat("\n=== TREND ANALYSIS ===\n")
karst_trends <- analyze_trends(karst_global, "Karst")
nonkarst_trends <- analyze_trends(nonkarst_global, "NonKarst")
combined_trends <- analyze_trends(combined_global, "Combined")

save_trend_statistics <- function(trends_list, filename) {
  all_stats <- data.frame()
  
  for(dataset_name in names(trends_list)) {
    trends <- trends_list[[dataset_name]]
    
    if(!is.null(trends) && length(trends$period_trends) > 0) {
      for(period_name in names(trends$period_trends)) {
        period_data <- trends$period_trends[[period_name]]
        
        stats_row <- data.frame(
          Dataset = dataset_name,
          Period = period_name,
          Years = paste(period_data$range[1], period_data$range[2], sep = "-"),
          Slope_Pg_yr = period_data$slope,
          P_Value = period_data$p_value,
          P_Value_Formatted = period_data$p_value_formatted,
          T_Value = period_data$t_value,
          DF = period_data$df,
          Mean_Flux_PgC = period_data$period_mean,
          Relative_Slope_Percent = period_data$relative_slope,
          Significant = ifelse(period_data$p_value < 0.05, "YES", "NO")
        )
        
        all_stats <- rbind(all_stats, stats_row)
      }
    }
  }
  
  write.csv(all_stats, filename, row.names = FALSE)
  cat("Trend statistics saved to:", filename, "\n")
  return(all_stats)
}

trends_list <- list(
  Karst = karst_trends,
  NonKarst = nonkarst_trends,
  Combined = combined_trends
)

trend_stats <- save_trend_statistics(trends_list, "results/trend_statistics_all_periods.csv")

create_flux_plot_all_periods <- function(trends) {
  if(is.null(trends)) {
    return(ggplot() + 
             labs(title = "No data available") +
             theme_void())
  }
  
  df <- trends$summary
  
  p <- ggplot(df, aes(x = year, y = mean_flux)) +
    geom_ribbon(aes(ymin = pmax(lower_ci, 0), ymax = upper_ci), 
                alpha = 0.3, fill = "steelblue") +
    geom_ribbon(aes(ymin = pmax(mean_flux - sd_flux, 0), ymax = mean_flux + sd_flux), 
                alpha = 0.2, fill = "gray") +
    geom_line(linewidth = 1.2, color = "black", alpha = 0.8) +
    geom_point(size = 2.5, color = "black", alpha = 0.8) +
    
    geom_vline(xintercept = c(2000, 2010), linetype = "dashed", color = "red", alpha = 0.7) +
    
    labs(
      title = paste("Global Soil Respiration -", trends$dataset_name, "Areas (1990-2022)"),
      subtitle = paste("Mean:", round(mean(df$mean_flux, na.rm = TRUE), 1), 
                      "¬±", round(sd(df$mean_flux, na.rm = TRUE), 1), "Pg C/year"),
      x = "Year",
      y = expression(Global~Soil~Respiration~(Pg~C~year^{-1}))
    ) +
    theme_minimal() +
    theme(
      plot.title = element_text(face = "bold", size = 14, hjust = 0.5),
      plot.subtitle = element_text(size = 11, hjust = 0.5, color = "darkred"),
      axis.title = element_text(size = 12),
      axis.text = element_text(size = 10),
      panel.grid.minor = element_blank()
    )
  
  if(length(trends$period_trends) > 0) {
    colors <- c("red", "darkorange", "purple", "darkgreen")
    i <- 1
    
    for(pn in names(trends$period_trends)) {
      tr <- trends$period_trends[[pn]]
      
      pred_year <- seq(tr$range[1], tr$range[2], length.out = 50)
      period_data <- df[df$year >= tr$range[1] & df$year <= tr$range[2], ]
      
      if(nrow(period_data) > 0) {
        base_value <- mean(period_data$mean_flux, na.rm = TRUE)
        pred_values <- tr$slope * (pred_year - mean(tr$range)) + base_value
        
        pred_data <- data.frame(year = pred_year, value = pred_values)
        
        line_alpha <- ifelse(tr$p_value < 0.05, 0.8, 0.4)
        line_size <- ifelse(tr$p_value < 0.05, 1.5, 1.0)
        
        p_display <- tr$p_value_formatted
        
        p <- p + 
          geom_line(data = pred_data, aes(x = year, y = value),
                    color = colors[i], linewidth = line_size, alpha = line_alpha) +
          # Add trend label with formatted p-value
          annotate("text",
                   x = mean(tr$range),
                   y = min(pred_data$value) + (max(pred_data$value) - min(pred_data$value)) * 0.1,
                   label = paste0(round(tr$slope, 3), " Pg C/yr\np ", p_display),
                   color = colors[i], size = 3.0, fontface = ifelse(tr$p_value < 0.05, "bold", "plain"))
      }
      i <- i + 1
    }
  }
  
  return(p)
}

create_period_plots <- function(trends) {
  if(is.null(trends)) return(list())
  
  plots <- list()
  df <- trends$summary
  
  periods <- list(
    "1990-2000" = c(1990, 2000),
    "2000-2010" = c(2000, 2010),
    "2010-2022" = c(2010, 2022),
    "1990-2022" = c(1990, 2022)
  )
  
  for(period_name in names(periods)) {
    period_range <- periods[[period_name]]
    period_data <- df[df$year >= period_range[1] & df$year <= period_range[2], ]
    
    if(nrow(period_data) > 0) {
      period_key <- switch(period_name,
                          "1990-2000" = "period1",
                          "2000-2010" = "period2",
                          "2010-2022" = "period3",
                          "1990-2022" = "period_full")
      
      period_trend <- trends$period_trends[[period_key]]
      
      p <- ggplot(period_data, aes(x = year, y = mean_flux)) +
        geom_ribbon(aes(ymin = pmax(mean_flux - sd_flux, 0), ymax = mean_flux + sd_flux),
                    alpha = 0.3, fill = "steelblue") +
        geom_line(linewidth = 1.2, color = "black") +
        geom_point(size = 2.5, color = "black") +
        
        labs(
          title = paste(trends$dataset_name, "-", period_name),
          x = "Year",
          y = expression(Global~Soil~Respiration~(Pg~C~year^{-1}))
        ) +
        theme_minimal() +
        theme(
          plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
          axis.title = element_text(size = 10),
          axis.text = element_text(size = 8)
        )
      
      if(!is.null(period_trend)) {
        pred_year <- seq(period_range[1], period_range[2], length.out = 50)
        base_value <- mean(period_data$mean_flux, na.rm = TRUE)
        pred_values <- period_trend$slope * (pred_year - mean(period_range)) + base_value
        
        pred_data <- data.frame(year = pred_year, value = pred_values)
        
        p_display <- period_trend$p_value_formatted
        
        p <- p + 
          geom_line(data = pred_data, aes(x = year, y = value),
                    color = "red", linewidth = 1.0, alpha = 0.8) +
          annotate("text",
                   x = mean(period_range),
                   y = max(period_data$mean_flux) * 0.9,
                   label = paste0("Slope: ", round(period_trend$slope, 4), " Pg C/yr\n",
                                 "p ", p_display),
                   color = "red", size = 3.0)
      }
      
      plots[[period_name]] <- p
    }
  }
  
  return(plots)
}

create_period_plots <- function(trends) {
  if(is.null(trends)) return(list())
  
  plots <- list()
  df <- trends$summary
  
  periods <- list(
    "1990-2000" = c(1990, 2000),
    "2000-2010" = c(2000, 2010),
    "2010-2022" = c(2010, 2022),
    "1990-2022" = c(1990, 2022)
  )
  
  for(period_name in names(periods)) {
    period_range <- periods[[period_name]]
    period_data <- df[df$year >= period_range[1] & df$year <= period_range[2], ]
    
    if(nrow(period_data) > 0) {
      period_key <- switch(period_name,
                          "1990-2000" = "period1",
                          "2000-2010" = "period2", 
                          "2010-2022" = "period3",
                          "1990-2022" = "period_full")
      
      period_trend <- trends$period_trends[[period_key]]
      
      p <- ggplot(period_data, aes(x = year, y = mean_flux)) +
        geom_ribbon(aes(ymin = pmax(mean_flux - sd_flux, 0), ymax = mean_flux + sd_flux),
                    alpha = 0.3, fill = "steelblue") +
        geom_line(linewidth = 1.2, color = "black") +
        geom_point(size = 2.5, color = "black") +
        
        labs(
          title = paste(trends$dataset_name, "-", period_name),
          x = "Year",
          y = expression(Global~Soil~Respiration~(Pg~C~year^{-1}))
        ) +
        theme_minimal() +
        theme(
          plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
          axis.title = element_text(size = 10),
          axis.text = element_text(size = 8)
        )
      
      if(!is.null(period_trend)) {
        pred_year <- seq(period_range[1], period_range[2], length.out = 50)
        base_value <- mean(period_data$mean_flux, na.rm = TRUE)
        pred_values <- period_trend$slope * (pred_year - mean(period_range)) + base_value
        
        pred_data <- data.frame(year = pred_year, value = pred_values)
        
        p_display <- period_trend$p_value_formatted
        
        p <- p + 
          geom_line(data = pred_data, aes(x = year, y = value),
                    color = "red", linewidth = 1.0, alpha = 0.8) +
          annotate("text",
                   x = mean(period_range),
                   y = max(period_data$mean_flux) * 0.9,
                   label = paste0("Slope: ", round(period_trend$slope, 4), " Pg C/yr\n",
                                 "p ", p_display),
                   color = "red", size = 3.0)
      }
      
      plots[[period_name]] <- p
    }
  }
  
  return(plots)
}

create_comparison_plot <- function(karst_trends, nonkarst_trends, combined_trends) {
  # Combine all data
  all_data <- bind_rows(
    karst_trends$summary %>% mutate(Region = "Karst"),
    nonkarst_trends$summary %>% mutate(Region = "Non-Karst"),
    combined_trends$summary %>% mutate(Region = "Global")
  )
  
  region_colors <- c("Karst" = "#E41A1C", "Non-Karst" = "#377EB8", "Global" = "#4DAF4A")
  
  p <- ggplot(all_data, aes(x = year, y = mean_flux, color = Region, fill = Region)) +
    geom_ribbon(aes(ymin = pmax(mean_flux - sd_flux, 0), ymax = mean_flux + sd_flux),
                alpha = 0.2, color = NA) +
    geom_line(linewidth = 1.2) +
    geom_point(size = 2, alpha = 0.8) +
    
    geom_vline(xintercept = c(2000, 2010), linetype = "dashed", color = "gray", alpha = 0.7) +
    
    scale_color_manual(values = region_colors) +
    scale_fill_manual(values = region_colors) +
    
    labs(
      title = "Comparison of Global Soil Respiration Across Regions (1990-2022)",
      subtitle = "SOC-Stock Weighted Estimates with Period Divisions",
      x = "Year",
      y = expression(Global~Soil~Respiration~(Pg~C~year^{-1})),
      color = "Region",
      fill = "Region"
    ) +
    theme_minimal() +
    theme(
      plot.title = element_text(face = "bold", size = 16, hjust = 0.5),
      plot.subtitle = element_text(size = 12, hjust = 0.5),
      axis.title = element_text(size = 12),
      axis.text = element_text(size = 10),
      legend.position = "bottom",
      panel.grid.minor = element_blank()
    )
  
  return(p)
}

create_summary_barplot <- function(karst_trends, nonkarst_trends, combined_trends) {
  summary_data <- data.frame(
    Region = c("Karst", "Non-Karst", "Global"),
    Mean_Flux = c(
      mean(karst_trends$summary$mean_flux),
      mean(nonkarst_trends$summary$mean_flux),
      mean(combined_trends$summary$mean_flux)
    ),
    SD_Flux = c(
      sd(karst_trends$summary$mean_flux),
      sd(nonkarst_trends$summary$mean_flux),
      sd(combined_trends$summary$mean_flux)
    )
  )
  
  p <- ggplot(summary_data, aes(x = Region, y = Mean_Flux, fill = Region)) +
    geom_col(alpha = 0.8) +
    geom_errorbar(aes(ymin = Mean_Flux - SD_Flux, ymax = Mean_Flux + SD_Flux),
                  width = 0.2, linewidth = 0.8) +
    geom_text(aes(label = paste0(round(Mean_Flux, 1), " Pg C/year")),
              vjust = -1, size = 4, fontface = "bold") +
    
    scale_fill_manual(values = c("Karst" = "#E41A1C", "Non-Karst" = "#377EB8", "Global" = "#4DAF4A")) +
    
    labs(
      title = "Average Global Soil Respiration (1990-2022)",
      subtitle = "SOC-Stock Weighted Estimates with Standard Deviation",
      x = "Region",
      y = expression(Mean~Soil~Respiration~(Pg~C~year^{-1}))
    ) +
    theme_minimal() +
    theme(
      plot.title = element_text(face = "bold", size = 14, hjust = 0.5),
      plot.subtitle = element_text(size = 11, hjust = 0.5),
      axis.title = element_text(size = 12),
      axis.text = element_text(size = 10),
      legend.position = "none"
    ) +
    ylim(0, max(summary_data$Mean_Flux + summary_data$SD_Flux) * 1.1)
  
  return(p)
}

check_flux_summary <- function(trends) {
  if(is.null(trends)) return()
  
  df <- trends$summary
  cat("\n=== ", trends$dataset_name, "===\n")
  cat("Overall mean R‚Çõ:", round(mean(df$mean_flux, na.rm=TRUE), 4), "Pg C/year\n")
  cat("Overall SD R‚Çõ:", round(sd(df$mean_flux, na.rm=TRUE), 4), "\n")
  cat("Range:", round(range(df$mean_flux, na.rm=TRUE), 4), "\n")
  
  mean_flux <- mean(df$mean_flux, na.rm=TRUE)
  if(trends$dataset_name == "Karst" && mean_flux >= 25 && mean_flux <= 45) {
    cat("‚úì Ecologically realistic range for karst\n")
  } else if(trends$dataset_name == "NonKarst" && mean_flux >= 55 && mean_flux <= 85) {
    cat("‚úì Ecologically realistic range for non-karst\n")
  } else if(trends$dataset_name == "Combined" && mean_flux >= 80 && mean_flux <= 110) {
    cat("‚úì Ecologically realistic range for combined\n")
  } else if(!is.na(mean_flux)) {
    cat("‚úó Ecologically unrealistic range\n")
  }
  
  if(length(trends$period_trends) > 0) {
    sig_table <- data.frame(
      Period = names(trends$period_trends),
      Slope_Pg_yr = sapply(trends$period_trends, function(x) x$slope),
      P_value = sapply(trends$period_trends, function(x) x$p_value),
      T_Value = sapply(trends$period_trends, function(x) x$t_value),
      DF = sapply(trends$period_trends, function(x) x$df),
      Significant = sapply(trends$period_trends, function(x) ifelse(x$p_value < 0.05, TRUE, FALSE))
    )
    print(sig_table)
  }
}


karst_period_plots <- create_period_plots(karst_trends)
nonkarst_period_plots <- create_period_plots(nonkarst_trends)
combined_period_plots <- create_period_plots(combined_trends)

# Save individual period plots (PNG and TIFF)
for(period_name in names(karst_period_plots)) {
  ggsave(paste0("plots/karst_", gsub("-", "_", period_name), ".png"), 
         karst_period_plots[[period_name]], width = 8, height = 6, dpi = 300, bg = "white")
  ggsave(paste0("plots/karst_", gsub("-", "_", period_name), ".tiff"), 
         karst_period_plots[[period_name]], width = 8, height = 6, dpi = 300, bg = "white")
}

for(period_name in names(nonkarst_period_plots)) {
  ggsave(paste0("plots/nonkarst_", gsub("-", "_", period_name), ".png"), 
         nonkarst_period_plots[[period_name]], width = 8, height = 6, dpi = 300, bg = "white")
  ggsave(paste0("plots/nonkarst_", gsub("-", "_", period_name), ".tiff"), 
         nonkarst_period_plots[[period_name]], width = 8, height = 6, dpi = 300, bg = "white")
}

for(period_name in names(combined_period_plots)) {
  ggsave(paste0("plots/combined_", gsub("-", "_", period_name), ".png"), 
         combined_period_plots[[period_name]], width = 8, height = 6, dpi = 300, bg = "white")
  ggsave(paste0("plots/combined_", gsub("-", "_", period_name), ".tiff"), 
         combined_period_plots[[period_name]], width = 8, height = 6, dpi = 300, bg = "white")
}

# Create and save comparison plot (PNG and TIFF)
p_comparison <- create_comparison_plot(karst_trends, nonkarst_trends, combined_trends)
ggsave("plots/comparison_all_regions.png", p_comparison, width = 14, height = 8, dpi = 300, bg = "white")
ggsave("plots/comparison_all_regions.tiff", p_comparison, width = 14, height = 8, dpi = 300, bg = "white")

# Create and save summary bar plot (PNG and TIFF)
p_summary <- create_summary_barplot(karst_trends, nonkarst_trends, combined_trends)
ggsave("plots/summary_soil_respiration.png", p_summary, width = 10, height = 8, dpi = 300, bg = "white")
ggsave("plots/summary_soil_respiration.tiff", p_summary, width = 10, height = 8, dpi = 300, bg = "white")

# Check flux summaries
check_flux_summary(karst_trends)
check_flux_summary(nonkarst_trends)
check_flux_summary(combined_trends)


check_flux_summary <- function(trends) {
  if(is.null(trends)) return()
  
  df <- trends$summary
  cat("\n=== ", trends$dataset_name, "===\n")
  cat("Overall mean R‚Çõ:", round(mean(df$mean_flux, na.rm=TRUE), 4), "Pg C/year\n")
  cat("Overall SD R‚Çõ:", round(sd(df$mean_flux, na.rm=TRUE), 4), "\n")
  cat("Range:", round(range(df$mean_flux, na.rm=TRUE), 4), "\n")
  
  mean_flux <- mean(df$mean_flux, na.rm=TRUE)
  if(trends$dataset_name == "Karst" && mean_flux >= 25 && mean_flux <= 45) {
    cat("‚úì Ecologically realistic range for karst\n")
  } else if(trends$dataset_name == "NonKarst" && mean_flux >= 55 && mean_flux <= 85) {
    cat("‚úì Ecologically realistic range for non-karst\n")
  } else if(trends$dataset_name == "Combined" && mean_flux >= 80 && mean_flux <= 110) {
    cat("‚úì Ecologically realistic range for combined\n")
  } else if(!is.na(mean_flux)) {
    cat("‚úó Ecologically unrealistic range\n")
  }
  
  if(length(trends$period_trends) > 0) {
    sig_table <- data.frame(
      Period = names(trends$period_trends),
      Slope_Pg_yr = sapply(trends$period_trends, function(x) x$slope),
      P_value = sapply(trends$period_trends, function(x) x$p_value),
      T_Value = sapply(trends$period_trends, function(x) x$t_value),
      DF = sapply(trends$period_trends, function(x) x$df),
      Significant = sapply(trends$period_trends, function(x) ifelse(x$p_value < 0.05, TRUE, FALSE))
    )
    print(sig_table)
  }
}


cat("\n", rep("=", 60), "\n", sep="")
cat("FINAL RESULTS - SOC-STOCK SCALING CORRECTED")
cat("\n", rep("=", 60), "\n", sep="")

check_flux_summary(karst_trends)
check_flux_summary(nonkarst_trends)
check_flux_summary(combined_trends)

# -------------------------------
# FINAL VALIDATION
# -------------------------------
cat("\n", rep("=", 60), "\n", sep="")
cat("ECOLOGICAL VALIDATION")
cat("\n", rep("=", 60), "\n", sep="")

get_mean_flux <- function(trends) {
  if(is.null(trends)) return(NA)
  mean(trends$summary$mean_flux, na.rm=TRUE)
}

final_means <- c(
  karst = get_mean_flux(karst_trends),
  nonkarst = get_mean_flux(nonkarst_trends),
  combined = get_mean_flux(combined_trends)
)

for(i in 1:length(final_means)) {
  mean_val <- final_means[i]
  if(!is.na(mean_val)) {
    if(names(final_means)[i] == "karst") {
      status <- ifelse(mean_val >= 25 & mean_val <= 45, "‚úì ECOLOGICALLY REALISTIC", "‚úó UNREALISTIC")
    } else if(names(final_means)[i] == "nonkarst") {
      status <- ifelse(mean_val >= 55 & mean_val <= 85, "‚úì ECOLOGICALLY REALISTIC", "‚úó UNREALISTIC")
    } else {
      status <- ifelse(mean_val >= 80 & mean_val <= 110, "‚úì ECOLOGICALLY REALISTIC", "‚úó UNREALISTIC")
    }
    cat(names(final_means)[i], ":", round(mean_val, 1), "Pg C/year -", status, "\n")
  }
}

if(all(final_means >= c(25, 55, 80) & final_means <= c(45, 85, 110))) {
  cat("\nüéâ ALL ESTIMATES ECOLOGICALLY REALISTIC! üéâ\n")
} else {
  cat("\n‚ö† Some estimates need adjustment\n")
}

cat("\n=== SAVING FINAL RESULTS ===\n")

# Save trend results
saveRDS(list(
  karst = karst_trends,
  nonkarst = nonkarst_trends,
  combined = combined_trends,
  final_means = final_means
), "results/final_soil_respiration_results.rds")

# Save summary statistics
summary_stats <- data.frame(
  Region = c("Karst", "Non-Karst", "Global"),
  Mean_Flux_PgC = final_means,
  SD_Flux_PgC = c(
    sd(karst_trends$summary$mean_flux),
    sd(nonkarst_trends$summary$mean_flux),
    sd(combined_trends$summary$mean_flux)
  ),
  Ecological_Status = c(
    ifelse(final_means["karst"] >= 25 & final_means["karst"] <= 45, "Realistic", "Unrealistic"),
    ifelse(final_means["nonkarst"] >= 55 & final_means["nonkarst"] <= 85, "Realistic", "Unrealistic"),
    ifelse(final_means["combined"] >= 80 & final_means["combined"] <= 110, "Realistic", "Unrealistic")
  )
)

write.csv(summary_stats, "results/summary_statistics.csv", row.names = FALSE)

cat("‚úì Final results saved to 'results/' directory\n")
cat("‚úì Trend statistics saved to 'results/trend_statistics_all_periods.csv'\n")
cat("‚úì Visualizations saved to 'plots/' directory\n")
cat("‚úì Debug files saved to 'debug/' directory\n")

cat("\n=== ANALYSIS COMPLETE ===\n")

# -------------------------------
# PRINT TREND RESULTS FOR KARST AND NON-KARST IN REQUESTED FORMAT
# -------------------------------

cat("\n=== KARST TREND RESULTS ===\n")
for(i in 1:nrow(trend_stats)) {
  row <- trend_stats[i, ]
  if(row$Dataset == "Karst" && row$Period %in% c("period1", "period2", "period3", "period_full")) {
    period_label <- switch(row$Period,
                          "period1" = "1990-2000",
                          "period2" = "2000-2010", 
                          "period3" = "2010-2022",
                          "period_full" = "1990-2022")
    
    direction <- ifelse(row$Slope_Pg_yr > 0, "increased", "decreased")
    
    # Format the significance string with p < 0.001 for values below threshold
    if(row$Significant == "YES") {
      if(row$P_Value < 0.001) {
        significance <- paste0("t", round(row$DF), " = ", round(abs(row$T_Value), 3), ", P < 0.001")
      } else {
        significance <- paste0("t", round(row$DF), " = ", round(abs(row$T_Value), 3), ", P = ", round(row$P_Value, 3))
      }
    } else {
      significance <- paste0("t", round(row$DF), " = ", round(abs(row$T_Value), 3), ", P = ", round(row$P_Value, 3))
    }
    
    cat("Annual global R‚Çõ", direction, "at a rate of", round(abs(row$Slope_Pg_yr), 2), 
        "Pg C yr‚Åª¬π in", period_label, "(", significance, ")\n")
  }
}

cat("\n=== NON-KARST TREND RESULTS ===\n")
for(i in 1:nrow(trend_stats)) {
  row <- trend_stats[i, ]
  if(row$Dataset == "NonKarst" && row$Period %in% c("period1", "period2", "period3", "period_full")) {
    period_label <- switch(row$Period,
                          "period1" = "1990-2000",
                          "period2" = "2000-2010", 
                          "period3" = "2010-2022",
                          "period_full" = "1990-2022")
    
    direction <- ifelse(row$Slope_Pg_yr > 0, "increased", "decreased")
    
    # Format the significance string with p < 0.001 for values below threshold
    if(row$Significant == "YES") {
      if(row$P_Value < 0.001) {
        significance <- paste0("t", round(row$DF), " = ", round(abs(row$T_Value), 3), ", P < 0.001")
      } else {
        significance <- paste0("t", round(row$DF), " = ", round(abs(row$T_Value), 3), ", P = ", round(row$P_Value, 3))
      }
    } else {
      significance <- paste0("t", round(row$DF), " = ", round(abs(row$T_Value), 3), ", P = ", round(row$P_Value, 3))
    }
    
    cat("Annual global R‚Çõ", direction, "at a rate of", round(abs(row$Slope_Pg_yr), 2), 
        "Pg C yr‚Åª¬π in", period_label, "(", significance, ")\n")
  }
}

# -------------------------------
# CREATE A SUMMARY TABLE WITH ALL TRENDS
# -------------------------------

cat("\n=== COMPREHENSIVE TREND SUMMARY ===\n")
summary_table <- data.frame()

for(dataset in c("Karst", "NonKarst", "Combined")) {
  for(period_key in c("period1", "period2", "period3", "period_full")) {
    # Find the row in trend_stats
    row_index <- which(trend_stats$Dataset == dataset & trend_stats$Period == period_key)
    
    if(length(row_index) > 0) {
      row <- trend_stats[row_index, ]
      
      period_label <- switch(period_key,
                            "period1" = "1990-2000",
                            "period2" = "2000-2010", 
                            "period3" = "2010-2022",
                            "period_full" = "1990-2022")
      
      summary_row <- data.frame(
        Region = dataset,
        Period = period_label,
        Slope_Pg_yr = round(row$Slope_Pg_yr, 2),
        T_Value = round(abs(row$T_Value), 3),
        DF = round(row$DF),
        P_Value = ifelse(row$P_Value < 0.001, "< 0.001", as.character(round(row$P_Value, 3))),
        Significant = row$Significant,
        Mean_Flux_PgC = round(row$Mean_Flux_PgC, 1)
      )
      
      summary_table <- rbind(summary_table, summary_row)
    }
  }
}

# Print the summary table
print(summary_table)

# Save the comprehensive summary
write.csv(summary_table, "results/comprehensive_trend_summary.csv", row.names = FALSE)
cat("\n‚úì Comprehensive trend summary saved to: results/comprehensive_trend_summary.csv\n")

# -------------------------------
# PRINT FORMAL RESULTS FOR PAPER/REPORT
# -------------------------------

cat("\n" , rep("=", 70), "\n", sep="")
cat("FORMAL RESULTS FOR MANUSCRIPT/REPORT")
cat("\n" , rep("=", 70), "\n", sep="")

# Karst results
cat("\n--- KARST REGIONS ---\n")
karst_rows <- summary_table[summary_table$Region == "Karst", ]
for(i in 1:nrow(karst_rows)) {
  row <- karst_rows[i, ]
  direction <- ifelse(row$Slope_Pg_yr > 0, "increased", "decreased")
  cat("Annual global R‚Çõ", direction, "at a rate of", abs(row$Slope_Pg_yr), 
      "Pg C yr‚Åª¬π in", row$Period, "(t", row$DF, "=", row$T_Value, ", P", row$P_Value, ")\n")
}

# Non-Karst results  
cat("\n--- NON-KARST REGIONS ---\n")
nonkarst_rows <- summary_table[summary_table$Region == "NonKarst", ]
for(i in 1:nrow(nonkarst_rows)) {
  row <- nonkarst_rows[i, ]
  direction <- ifelse(row$Slope_Pg_yr > 0, "increased", "decreased")
  cat("Annual global R‚Çõ", direction, "at a rate of", abs(row$Slope_Pg_yr), 
      "Pg C yr‚Åª¬π in", row$Period, "(t", row$DF, "=", row$T_Value, ", P", row$P_Value, ")\n")
}

# Combined results
cat("\n--- GLOBAL (COMBINED) ---\n")
combined_rows <- summary_table[summary_table$Region == "Combined", ]
for(i in 1:nrow(combined_rows)) {
  row <- combined_rows[i, ]
  direction <- ifelse(row$Slope_Pg_yr > 0, "increased", "decreased")
  cat("Annual global R‚Çõ", direction, "at a rate of", abs(row$Slope_Pg_yr), 
      "Pg C yr‚Åª¬π in", row$Period, "(t", row$DF, "=", row$T_Value, ", P", row$P_Value, ")\n")
}

# -------------------------------
# ADDITIONAL ANALYSIS: COMPARE TRENDS BETWEEN REGIONS
# -------------------------------

cat("\n" , rep("=", 70), "\n", sep="")
cat("TREND COMPARISON BETWEEN REGIONS")
cat("\n" , rep("=", 70), "\n", sep="")

# Compare slopes between karst and non-karst for each period
for(period_key in c("period1", "period2", "period3", "period_full")) {
  period_label <- switch(period_key,
                        "period1" = "1990-2000",
                        "period2" = "2000-2010", 
                        "period3" = "2010-2022",
                        "period_full" = "1990-2022")
  
  karst_slope <- trend_stats$Slope_Pg_yr[trend_stats$Dataset == "Karst" & trend_stats$Period == period_key]
  nonkarst_slope <- trend_stats$Slope_Pg_yr[trend_stats$Dataset == "NonKarst" & trend_stats$Period == period_key]
  
  if(length(karst_slope) > 0 && length(nonkarst_slope) > 0) {
    slope_difference <- karst_slope - nonkarst_slope
    relative_difference <- (slope_difference / ((karst_slope + nonkarst_slope)/2)) * 100
    
    cat("\n", period_label, ":\n")
    cat("  Karst slope:", round(karst_slope, 3), "Pg C yr‚Åª¬π\n")
    cat("  Non-Karst slope:", round(nonkarst_slope, 3), "Pg C yr‚Åª¬π\n")
    cat("  Difference:", round(slope_difference, 3), "Pg C yr‚Åª¬π")
    cat(" (", round(relative_difference, 1), "% difference)\n", sep="")
    
    if(abs(relative_difference) > 10) {
      if(relative_difference > 0) {
        cat("  ‚Üí Karst regions show ", round(relative_difference, 1), "% higher rate of change\n", sep="")
      } else {
        cat("  ‚Üí Non-Karst regions show ", round(abs(relative_difference), 1), "% higher rate of change\n", sep="")
      }
    }
  }
}

# -------------------------------
# FINAL SUMMARY STATISTICS
# -------------------------------

cat("\n" , rep("=", 70), "\n", sep="")
cat("OVERALL SUMMARY STATISTICS")
cat("\n" , rep("=", 70), "\n", sep="")

# Calculate average slopes across all periods
for(region in c("Karst", "NonKarst", "Combined")) {
  region_slopes <- trend_stats$Slope_Pg_yr[trend_stats$Dataset == region]
  region_means <- trend_stats$Mean_Flux_PgC[trend_stats$Dataset == region]
  
  if(length(region_slopes) > 0) {
    avg_slope <- mean(region_slopes, na.rm = TRUE)
    avg_flux <- mean(region_means, na.rm = TRUE)
    
    cat("\n", region, "Regions:\n")
    cat("  Average R‚Çõ trend:", round(avg_slope, 3), "Pg C yr‚Åª¬π\n")
    cat("  Average annual flux:", round(avg_flux, 1), "Pg C year‚Åª¬π\n")
    
    # Interpret the trend
    if(abs(avg_slope) < 0.1) {
      cat("  ‚Üí Relatively stable over time\n")
    } else if(avg_slope > 0) {
      cat("  ‚Üí Overall increasing trend\n")
    } else {
      cat("  ‚Üí Overall decreasing trend\n")
    }
  }
}

cat("\n" , rep("=", 70), "\n", sep="")
cat("ANALYSIS COMPLETE - ALL TREND RESULTS GENERATED")
cat("\n" , rep("=", 70), "\n", sep="")
